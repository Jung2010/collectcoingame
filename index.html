<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta charset="utf-8">
</head>

<style>

    @font-face {
        font-family: 'LINESeedKR-Bd';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_11-01@1.0/LINESeedKR-Bd.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
    }
    * {
        transition: all 0.2s;
        font-family: 'LINESeedKR-Bd';
    }
    body {
        background: rgba(0,0,255,0.1);
    }
    main {
        padding: 40px;
    }
    #appearMoney {
        font-size: 30px;
        padding:0; margin:0;
        margin-left: 30px;
    }
    #moneyDisplay {
        color: royalblue;
    }
    #moneyDisplay:hover {
        color: blue;
    }
    table { width:100%; }

    .dealBtn {
        transition: all 0s;
        border: none;
        background: none;
        outline: none;
        padding: 5px;
        padding-left: 20px;
        padding-right: 20px;
        margin-left: 10px;
        border-radius: 10px;
        color: white;
    }
    .dealBtn:hover {
        transform: scale(110%);
    }
    .dealBtn:active {
        transform: scale(90%);
    }
    #buyBtn {
        background: red;
    }
    #sellBtn,#allSellBtn {
        background: royalblue;
    }
    card {
        display: block;
        float: left;
        width: 400px;
        background: beige;
        margin: 20px;
        border-radius: 10px;
        padding: 0px;
        background: none;
        transition: all 0s;
        border: 4px solid lightgray;
        background: white;
    }
    card:hover {
        background: white;
        /*box-shadow: 0px 0px 5px 0px royalblue;*/
        border-color: royalblue;
    }
    #priceGraph {
        background:skyblue;
        border-radius: 10px 10px 0px 0px;
        width: 100%;
        height: 200px;
        background: linear-gradient(white,royalblue);
        border-bottom: 4px solid lightgray;
    }
    .header_btn {
        padding: 6px;
        font-size: 18px;
        background: aliceblue;
        border-radius: 5px;
        border: 2px solid lightgray;
        transition: all 0.2s;
        float: right;
        margin-left: 10px;
    }
    .header_btn:hover {
        background: white;
        transform: rotate(10deg) scale(110%);
    }
    .header_btn:active {
        transform: rotate(0deg);
    }
    @media screen and (max-width: 500px) {
        main { padding: 5px; }
        #priceGraph {
            background: linear-gradient(white,royalblue);
        }
        card {
            margin: 0;
            margin-bottom: 10px;
            background: none;
            width: 100%;
        }
        #stopBtn {
            width: 100%;
        }
    }

    #header {
        position: fixed;
        padding: 30px;
        box-shadow: 0px 0px 10px 0px lightgray;
        background: rgb(250,250,250);
        top: 0;
        left: 0;
        right: 0;
    }

    #header p {
        display: inline-block;
    }

    .number {
        font-family: 'Courier New', Courier, monospace;
        font-weight: 900;
    }

    #thingTable {
        margin-top: 100px;
        padding: 30px;
    }

    .dlg {
        position: fixed;
        width: 400px;
        background: aliceblue;
        border: none;
        border-radius: 20px;
        box-shadow: 0px 0px 10px 0px gray;
        animation: dlgOpen 0.5s;
        top: 20%;
        bottom: 50px;
        height: auto;
        padding: 20px;
        overflow-y: auto;
    }
    .dlg h2 {
        border-bottom: 3px solid gray;
        padding: 10px;
    }
    @keyframes dlgOpen {
        0%{
            transform: scale(0%) translateY(-200px);
        }
    }

    .closeBtn {
        width: 20px;
        height: 20px;
        background: red;
        border: none;
        border-radius: 100%;
        float: right;
    }
    .closeBtn:hover {
        background: darkred;
    }
    form[method=dialog] {
        display: inline;
    }
    #iptDlg {
        top:auto;bottom:auto;
    }
    #dlg_ipt {
        width: 100%;
        border-radius: 10px 10px 0px 0px;
        border: none;
        outline: none;
        padding: 10px;
        font-size: 20px;
    }
    #dlg_ipt:hover {
        background: lightgray;
    }
    #iptDlg button {
        width: 100%;
        border-radius: 0px 0px 10px 10px;
        border: none;
        background: royalblue;
        color: white;
        padding: 5px;
        font-size: 15px;
    }
    #iptDlg h2 {
        border: none;
        text-align: center;
        color: royalblue;
    }
</style>

<main>
    <div id="header">
        <p id="appearMoney">
            üî• <span id='moneyDisplay'>0</span> coins
        </p>
        |
        <span id='playedTime'>...</span>
        <button id='stopBtn' class="header_btn" title="ÌÑ¥ Î©àÏ∂îÍ∏∞/ÌÑ¥ Í≥ÑÏÜçÌïòÍ∏∞">STOP BTN</button>
        <button class="header_btn" title="Í∏∞Î°ùÎ≥¥Í∏∞" onclick="$('#logDlg').open=true;">üìú</button>
        <button class="header_btn" title="Ï¥àÍ∏∞ÌôîÌïòÍ∏∞" id="ini_btn">‚úàÔ∏è</button>
    </div>
    <div id='thingTable'></div>
</main>

<dialog class="dlg" id="logDlg">
    <h2>
        LOG
        <form method="dialog">
            <button class="closeBtn"></button>
        </form>
    </h2>
    <div id="logs"></div>
</dialog>

<dialog id="iptDlg" class="dlg">
    <h2>LOREM IPSUM</h2>
    <p>Lorem Ipsum Dolor Amet,</p>
    <input id="dlg_ipt">
    <button onclick="submit()">ENTER</button>
</dialog>

<script>
const $ = v=>document.querySelector(v);
const thingDatas = [];
let stopped = false;

(()=>{
    let coins = 1000;
    const copy = (obj) => {
        if(typeof obj !== "object" || obj === null){
            return obj;
        }
        
        const deepCopyObj = {};
        
        for(let key in obj){
            deepCopyObj[key] = copy(obj[key]);
        }
        
        return deepCopyObj;
    }
    let things = [
        {
            name: 'Í≤ΩÏ†úÏßÄÌëú',
            eng_name: 'Economic Indicator',
            price: 0,
            maxCh: 0, // ÏµúÎåÄ Î≥ÄÎèôÎ•†
            rise: 0, // Ïò§Î•º ÌôïÎ•†
            owning: 0, // ÏÜåÏú†Ï§ë
            changed: "", // ÏñºÎßàÎÇò Î≥ÄÎèô ÎêòÏóàÎäîÏßÄ
            risingTerm: false, // ÏÉÅÏäπÏÑ∏Ïù∏Í∞Ä
            fallingTerm: false, // ÌïòÎùΩÏÑ∏Ïù∏Í∞Ä
            cutline: Infinity // ÏµúÎåÄÍ∞ÄÍ≤©
        },
        {
            name: 'Í∏à',
            eng_name: 'Gold',
            price: 1000,
            maxCh: 0.05, // ÏµúÎåÄ Î≥ÄÎèôÎ•†
            rise: 0.5, // Ïò§Î•º ÌôïÎ•†
            owning: 0, // ÏÜåÏú†Ï§ë
            changed: "", // ÏñºÎßàÎÇò Î≥ÄÎèô ÎêòÏóàÎäîÏßÄ
            risingTerm: true, // ÏÉÅÏäπÏÑ∏Ïù∏Í∞Ä
            fallingTerm: false, // ÌïòÎùΩÏÑ∏Ïù∏Í∞Ä
            rtPossibility : 0.2, // ÏÉÅÏäπÏÑ∏ ÌôïÎ•†
            ftPossibility : 0.1, // ÌïòÎùΩÏÑ∏ ÌôïÎ•†
            cutline: 15000 // ÏµúÎåÄÍ∞ÄÍ≤©
        },
        {
            name: 'ÏùÄ',
            eng_name: 'Silver',
            price: 500,
            maxCh: 0.025,
            rise: 0.5,
            owning: 0,
            changed: "",
            risingTerm: true,
            fallingTerm: false,
            cutline: 3000
        },
        {
            name: 'ÏΩîÏù∏',
            eng_name: 'Coin',
            price: 200,
            maxCh: 0.1,
            rise: 0.5,
            owning: 0,
            changed: "",
            risingTerm: true,
            fallingTerm: false,
            cutline: 1000000
        },
        {
            name: 'Ï£ºÏãù',
            eng_name: 'Stock',
            price: 5000,
            maxCh: 0.05,
            rise: 0.52,
            owning: 0,
            changed: "",
            risingTerm: false,
            fallingTerm: false,
            cutline: 20000
        },
        {
            name: 'ÏïÑÌååÌä∏',
            eng_name: 'Apartment',
            price: 10000000,
            maxCh: 0.07,
            rise: 0.58,
            owning: 0,
            changed: "",
            risingTerm: false,
            fallingTerm: false,
            cutline: 300000000
        },
        {
            name: 'Ìò∏ÌÖî',
            eng_name: 'Hotel',
            price: 50000000,
            maxCh: 0.02,
            rise: 0.6,
            owning: 0,
            changed: "",
            risingTerm: false,
            fallingTerm: false,
            cutline: 400000000
        }
    ];
    const specimenTh = copy(things);
    let playedTime = 0;
    // Îç∞Ïù¥ÌÑ∞ ÏÑ∏ÌåÖ ÎÅù

    //Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎã§Î©¥ Î∂àÎü¨Ïò§Í∏∞:
    const loaddats = localStorage.getItem("DATAS");
    if(loaddats) {
        const dats = JSON.parse(loaddats);
        things = dats.env;
        coins = dats.user.coin;
        playedTime = dats.user.playtime;
    }

    const $logs = $("#logs");
    const buyThing = (i,n=1)=>{
        const dats = things[i];
        const price = dats.price;
        if(coins>=price*n) {
            coins-=price*n;
            dats.owning+=n;

            $logs.innerHTML += `
            <span style="color:red;">
                ${dats.name} Íµ¨Îß§ : ${n}Í∞ú ( - ${(price*n).toFixed(2)} ÏΩîÏù∏ )
            </span><br>
            `;
        }
    }
    const sellThing = (i,n=1)=>{
        const dats = things[i];
        const price = dats.price;
        if(dats.owning>=n) {
            coins+=price*n;
            dats.owning-=n;

            $logs.innerHTML += `
            <span style="color:royalblue;">
                ${dats.name} ÌåêÎß§ : ${n}Í∞ú ( + ${(price*n).toFixed(2)} ÏΩîÏù∏ )
            </span><br>
            `;
        }
    }
    const changingTime = 1000; // Ìã±

    const $coinDisplay = $('#moneyDisplay');
    setInterval(()=>{ // ÎîîÏä§ÌîåÎ†àÏù¥
        $coinDisplay.innerHTML = coins.toFixed(2);
    });
    const $stopBtn = $("#stopBtn");

    (function changePrice(){ // Í∞ÄÍ≤© Î≥ÄÎèô
        stopBtn.innerHTML=stopped?"üöó":"üöß";
        stopBtn.title=stopped?"Í≥ÑÏÜç ÏßÑÌñâÌïòÍ∏∞":"Î©àÏ∂îÍ∏∞";
        if(stopped) stopBtn.onclick=(()=>{
            stopped=false;
            changePrice();
        });
        else stopBtn.onclick=(()=>{stopped=true;});

        playedTime++;
        const allWealth = coins+things.reduce( (pre,cur)=>pre+cur.price*cur.owning,0 );
        $('#playedTime').innerHTML = `
        
        <span style='color:darkblue'>${playedTime}</span> turns
        ( <span style='color:darkblue'>${Math.round(allWealth/playedTime)}</span> coins/turns )
        
        `;

        for(let i = 0; i < things.length;i++){
            const th = things[i]; // ÏÑ†ÌÉùÎêú Î¨ºÍ±¥
            let changing = Math.random()*th.maxCh; // Î≥ÄÎèôÎ•†
            const ifRise = Math.random()<=( th.rise*( th.risingTerm? 0.75: (th.fallingTerm?0.25:0.5) ) ); // Ïò§Î•ºÏßÄ?
            if(ifRise&&th.risingTerm) changing+=0.1; // ÏÉÅÏäπÏÑ∏&ÏÉÅÏäπÎùºÎ©¥ Î≥ÄÎèô +10%p
            if(!ifRise&&th.fallingTerm) changing+=0.09; // ÌïòÎùΩÏÑ∏&&ÌïòÎùΩÎùºÎ©¥ Î≥ÄÎèô +9%p
            const thPrice = ((ifRise?1:-1)*(changing)*th.price+th.price); // Í∞ÄÍ≤©Ï±ÖÏ†ï
            const changed = (ifRise?"+":"-")+(changing*100).toFixed(2); // Î≥ÄÎèôÎ•†(Î¨∏ÏûêÏó¥%)
            if(Math.random()<(th.rtPossibility||0.05)&&th.risingTerm&&!th.fallingTerm){ // 5%Ïùò ÌôïÎ•†Î°ú ÏÉÅÏäπÏÑ∏ ÎÅù
                th.risingTerm=false;
            }
            if(Math.random()<(
                th.price<th.cutline?0.06:0.05
            )) { // 6%Ïùò ÌôïÎ•†Î°ú ÏÉÅÏäπÏÑ∏ ÏãúÏûë, Îã® Í∞ÄÍ≤©Ïù¥ Ïª§Ìä∏ÎùºÏù∏Î≥¥Îã§ ÎÜíÏúºÎ©¥ 5ÌçºÏÑºÌä∏
                th.risingTerm=true;
            }
            if(Math.random()<(th.ftPossibility||0.05)&&th.fallingTerm){ // 5%Ïùò ÌôïÎ•†Î°ú ÌïòÎùΩÏÑ∏ ÎÅù
                th.fallingTerm=false;
            }
            if(Math.random()<(
                th.price<th.cutline?0.07:0.12
            )) { // 7%Ïùò ÌôïÎ•†Î°ú ÌïòÎùΩÏÑ∏ ÏãúÏûë, Îã® Í∞ÄÍ≤©Ïù¥ Ïª§Ìä∏ÎùºÏù∏Î≥¥Îã§ ÎÜíÏúºÎ©¥ 12ÌçºÏÑºÌä∏
                th.fallingTerm=true;
            }
            // console.log(`NM:${th.name} RT:${th.risingTerm} FT:${th.fallingTerm}`);
            th.price = thPrice;
            th.changed = changed;
            /*
            document.write(`
            <span style='
            color:${ifRise?"red":"blue"};
            '>
            ${th.name} : ${thPrice} ( ${(ifRise?"+":"-")}${(changing*100).toFixed(2)}% )<br>
            </span>
            `);
            */
           
           if(th.name==="Í≤ΩÏ†úÏßÄÌëú") {
               th.price = things.reduce((pre,cur)=>pre+(cur.name==="Í≤ΩÏ†úÏßÄÌëú"?0:cur.price),0)/things.length;
            }
            
            if(th.risingTerm===th.fallingTerm) th.fallingTerm=false;
            
            if(th.price <= 50) {
                console.log(copy(specimenTh[i]));
                things[i] = copy(specimenTh[i]);
            }
        }
        thingDatas.push(copy(things));
        const $thingTable = $("#thingTable");
        $thingTable.innerHTML=`
        
            ${things.reduce((html,cur,index)=>{
                return html+`
                <card>        
                    
                    <canvas id='priceGraph'></canvas>

                    <div style='padding:30px;'>
                        <p>
                            <h2 style='
                            margin-bottom: 0;
                            padding-bottom: 0;
                            display: inline-block;
                            '
                            >${cur.name}</h2>
                            <small> | ${cur.eng_name}</small> <br>
                            
                            <p ${cur.name==="Í≤ΩÏ†úÏßÄÌëú"?"style='visibility:hidden'":""}>
                                <button class='dealBtn' id='buyBtn' style='
                                margin-left: 0px;
                                '>Íµ¨Îß§</button>
                                <button class='dealBtn' id='sellBtn'>ÌåêÎß§</button>
                                <button class='dealBtn' id='allSellBtn'>Ï†ÑÎ∂Ä ÌåêÎß§</button>
                            </p>
                        </p>

                        <span class='number' style='
                        color: darkblue;
                        '>ü™ô ${(cur.price).toFixed(2)}</span>
                        ( <span class="number" style='
                            color:${cur.changed[0]==="-"?"royalblue":"red"};
                        '>${cur.changed}</span>% )<br>
                        üí∞ <span style='color:darkblue;'>${Math.floor(coins/cur.price)}</span>Í∞ú Íµ¨Îß§Í∞ÄÎä•
                        
                        <br>

                        üõí <span style='
                        color: darkblue;
                        '>${cur.owning}</span>Í∞ú ÏÜåÏú†Ï§ë (
                            <span style='color:darkblue;' class="number">${(cur.owning*cur.price).toFixed(2)}</span>
                        coins )
                    </div>
                    
                </card>
                `;
            },"")}
        
        `;

        const $all = v=>document.querySelectorAll(v);

        const buyBtns = $all('#buyBtn');
        const sellBtns = $all('#sellBtn');
        const allSellBtns = $all('#allSellBtn');
        const priceGraphs = $all('#priceGraph');
        for(let i = 0; i < things.length; i++) {
            
            (()=>{
                const mark = 100; // ÌëúÏãú Î≤îÏúÑ
                const datas = thingDatas;
                const until = thingDatas.length>mark?mark:thingDatas.length;
                const arr = [];
                for(let j = thingDatas.length; j > thingDatas.length-until; j--) {
                    arr.push(thingDatas[j-1]?.[i]?.price??0);
                }
                const gf = priceGraphs[i];
                const ctx = gf.getContext("2d");
                const w = gf.width;
                const h = gf.height;
                const maxH = h/Math.max(...arr);
                ctx.strokeStyle='darkblue';
                for(let n = 1; n < arr.length+1; n++) {
                    const x = w-n*(w/arr.length);
                    const y = h-arr[n-2]*maxH*0.8;
                    if(n===1) ctx.moveTo(x,y);
                    ctx.lineTo(x,y);
                }
                ctx.stroke();
            })(); // Í∞ÄÍ≤© Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞


            buyBtns[i].addEventListener('click',_=>buyThing(i,(()=>{
                const n = prompt('ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî(Í∏∞Î≥∏Í∞í:1)');
                if(typeof (+n) === 'number') {
                    return (+n);
                } else {
                    return 1;
                }
            })()));
            sellBtns[i].addEventListener('click',_=>sellThing(i,(()=>{
                const n = prompt('ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî(Í∏∞Î≥∏Í∞í:1)');
                if(typeof (+n) === 'number') {
                    return (+n);
                } else {
                    return 1;
                }
            })()));
            allSellBtns[i].addEventListener('click',_=>sellThing(i,(()=>{
                return things[i].owning;
            })()));
            document.body.onkeydown = e=>{
                if(e.key==="S") {
                    stopBtn.onclick=(()=>{stopped=true;});
                    stopped=true;
                }
            };
        }

        const savingData = JSON.stringify({
            env:things,
            user:{
                coin:coins,
                playtime:playedTime
            }
        });
        localStorage.setItem("DATAS",savingData);
        
        $("#ini_btn").onclick=()=>{
            localStorage.clear();
            stopped=true;
            location.reload();
        };
        if(!stopped) setTimeout(changePrice,changingTime);
        
    })();
})();
</script>
